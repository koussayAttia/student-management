pipeline {
  agent any

  tools {
    jdk 'JAVA_HOME'
    maven 'M2_HOME'
  }

  environment {
    GIT_CREDENTIALS_ID       = '14409463'
    GIT_BRANCH               = 'main'
    GIT_URL                  = 'https://github.com/koussayAttia/student-management.git'

    DOCKERHUB_REPO           = 'koussaybenattia/student-management'
    DOCKERHUB_CREDENTIALS_ID = 'efb9d575-c792-451d-8397-39d6121e21ba'

    // sera remplacée après "minikube service ... --url"
    SONAR_HOST_URL      = 'http://localhost:9000'
    // ID Jenkins Credentials (String secret) contenant ton token Sonar
    SONAR_TOKEN_CRED_ID = 'SonarQube_Pat'
  }

  stages {
    stage('Checkout') {
      steps {
        git branch: env.GIT_BRANCH, url: env.GIT_URL, credentialsId: env.GIT_CREDENTIALS_ID
      }
    }

    stage('Build (clean & package, sans tests)') {
      steps {
        dir('student-management') {
          sh 'mvn clean package -DskipTests'
        }
      }
    }

    stage('Deploy Infra (MySQL + SonarQube)') {
      steps {
        dir('student-management') {
          sh '''
            set -eux

            minikube kubectl -- get namespace devops || minikube kubectl -- create namespace devops

            minikube kubectl -- apply -f mysql-deployment.yaml -n devops
            minikube kubectl -- apply -f sonarqube-deployment.yaml -n devops

            minikube kubectl -- rollout status deployment/sonarqube -n devops --timeout=900s

            SONAR_URL=$(minikube service sonarqube-service -n devops --url | head -n 1)
            echo "SONAR_HOST_URL=$SONAR_URL" > sonar_url.env

            # attendre que SonarQube soit UP
            for i in $(seq 1 120); do
              if curl -sf "$SONAR_URL/api/system/status" | grep -q '"status":"UP"'; then
                echo "SonarQube is UP"
                break
              fi
              echo "Waiting SonarQube..."
              sleep 5
            done
          '''
          script {
            env.SONAR_HOST_URL = readFile('sonar_url.env').trim().split('=')[1]
            echo "Using SONAR_HOST_URL=${env.SONAR_HOST_URL}"
          }
        }
      }
    }

    stage('SonarQube Analysis') {
      steps {
        dir('student-management') {
          withCredentials([string(credentialsId: env.SONAR_TOKEN_CRED_ID, variable: 'SONAR_TOKEN')]) {
            withSonarQubeEnv('SonarQube') {
              sh '''
                mvn sonar:sonar \
                  -Dsonar.projectKey=student-management \
                  -Dsonar.projectName=student-management \
                  -Dsonar.host.url=$SONAR_HOST_URL \
                  -Dsonar.login=$SONAR_TOKEN
              '''
            }
          }
        }
      }
    }

    stage('Build Docker Image') {
      steps {
        dir('student-management') {
          sh 'docker build -t $DOCKERHUB_REPO:$BUILD_NUMBER .'
        }
      }
    }

    stage('Push Docker Image to Docker Hub') {
      steps {
        withCredentials([usernamePassword(
          credentialsId: env.DOCKERHUB_CREDENTIALS_ID,
          usernameVariable: 'DOCKERHUB_USER',
          passwordVariable: 'DOCKERHUB_PASS'
        )]) {
          sh '''
            echo "$DOCKERHUB_PASS" | docker login -u "$DOCKERHUB_USER" --password-stdin
            docker push $DOCKERHUB_REPO:$BUILD_NUMBER
          '''
        }
      }
    }

    stage('Deploy to Kubernetes') {
      steps {
        dir('student-management') {
          sh '''
            set -eux
            minikube kubectl -- apply -f spring-deployment.yaml -n devops
            minikube kubectl -- get pods -n devops
          '''
        }
      }
    }
  }
}
